// --- Translations Dictionary ---
const translations = {
    "en": {
        "nav_about": "About",
        "nav_experience": "Experience",
        "nav_skills": "Skills",
        "nav_contact": "Contact",
        "hero_title": "Filippo Mario Codecà",
        "hero_subtitle_words": ["Senior Operations Manager", "Supply Chain Expert", "Crisis Management Specialist", "Lean Six Sigma Leader"],
        "hero_desc": "Driving efficiency in Automotive, Plant Management, and Logistics Optimization across Europe.",
        "btn_contact": "Get in Touch",
        "btn_profile": "View Hogan Profile",
        "sec_about_title": "Professional Profile",
        "sec_about_h3": "Senior Leader in Manufacturing",
        "sec_about_p1": "Born in Milan and currently based in Slovakia, I am a seasoned manager with extensive experience in the automotive and manufacturing sectors. I specialize in <strong>Plant Management, Logistics, and Supply Chain optimization</strong>.",
        "sec_about_p2": "My career is defined by flexibility and high technical focus, having successfully managed start-ups, restructuring projects, and interim management roles across Europe (Italy, Slovakia, Germany).",
        "card_lang": "Languages",
        "card_edu": "Education",
        "sec_exp_title": "Career Journey",
        "role_nig": "Coordinator / Site Manager",
        "desc_nig": "Supervising installation of production lines in the automotive sector. Managing daily team coordination, client relationships, and material availability.",
        "role_jlr": "Senior Production Leader (T&F)",
        "desc_jlr": "Managed Trim & Final Operation zone (120 people). Drove SQDCPE metrics, safety compliance, and Lean manufacturing principles (Kaizen, 5S).",
        "role_opel": "Manager Development",
        "desc_opel": "Study of chassis geometry and production process quality for the new Opel Grandland BEV project, focusing on \"Body Sides\".",
        "role_ho": "Assistant Supervisor",
        "desc_ho": "Managed installation projects for Jeep Ineos Grenadier, Krone trailers, and Opel Grandland conveyor systems.",
        "role_phoenix": "Supply Chain Director",
        "desc_phoenix": "Optimized biomass supply chain, reduced shipping costs, and managed international transport regulations (Air, Sea, Rail, Road).",
        "role_brixia": "Plant Production & Logistics Manager",
        "desc_brixia": "Aluminium die casting for Bosch, Continental, Magna. Reorganized supply chain, reduced suppliers, and managed plant productivity.",
        "role_scand": "Logistics & Purchasing Manager",
        "desc_scand": "Packaging manufacturing. Reduced raw material and energy purchase prices. Defined strategic supply objectives and managed warehouse accounting.",
        "role_serio": "Operation Manager",
        "desc_serio": "Led the start-up phase: construction compliance, layout design, staff recruitment, machinery purchasing, and ISO 9001 implementation.",
        "sec_skills_title": "Core Competencies",
        "filter_all": "All",
        "filter_mgmt": "Management",
        "filter_tech": "Technical",
        "filter_ind": "Industry",
        "sk_supply": "Supply Chain Management",
        "sk_plant": "Plant Operations",
        "sk_lean": "Lean Manufacturing (Kaizen, 5S)",
        "sk_interim": "Interim Management",
        "sk_auto": "Automotive Industry",
        "sk_log": "Logistics Optimization",
        "sk_crisis": "Crisis Management",
        "sk_sqdcpe": "SQDCPE Metrics",
        "sk_iso": "ISO 9001 / IATF",
        "sk_sap": "SAP / AS400 / MS Office",
        "sk_cost": "Cost Reduction",
        "sk_start": "Start-up Leadership",
        "sec_map_title": "International Experience",
        "sec_map_desc": "A track record of success across key European manufacturing hubs.",
        "sec_contact_title": "Contact Me"
    },
    "it": {
        "nav_about": "Chi Sono",
        "nav_experience": "Esperienza",
        "nav_skills": "Competenze",
        "nav_contact": "Contatti",
        "hero_title": "Filippo Mario Codecà",
        "hero_subtitle_words": ["Senior Operations Manager", "Esperto di Supply Chain", "Specialista gestione crisi", "Leader Lean Six Sigma"],
        "hero_desc": "Guido l'efficienza nel settore Automotive, gestione impianti e ottimizzazione logistica in tutta Europa.",
        "btn_contact": "Contattami",
        "btn_profile": "Vedi Profilo Hogan",
        "sec_about_title": "Profilo Professionale",
        "sec_about_h3": "Leader Senior nel Manifatturiero",
        "sec_about_p1": "Nato a Milano e attualmente con sede in Slovacchia, sono un manager esperto con vasta esperienza nei settori automotive e manifatturiero. Sono specializzato in <strong>Plant Management, Logistica e ottimizzazione della Supply Chain</strong>.",
        "sec_about_p2": "La mia carriera è definita da flessibilità e alto focus tecnico, avendo gestito con successo start-up, progetti di ristrutturazione e ruoli di interim management in Europa (Italia, Slovacchia, Germania).",
        "card_lang": "Lingue",
        "card_edu": "Istruzione",
        "sec_exp_title": "Percorso di Carriera",
        "role_nig": "Coordinatore / Site Manager",
        "desc_nig": "Supervisione installazione linee di produzione settore automotive. Gestione coordinamento quotidiano team, relazioni clienti e disponibilità materiali.",
        "role_jlr": "Senior Production Leader (T&F)",
        "desc_jlr": "Gestione zona Trim & Final (120 persone). Guida metriche SQDCPE, conformità sicurezza e principi Lean (Kaizen, 5S).",
        "role_opel": "Manager Sviluppo",
        "desc_opel": "Studio geometria telaio e qualità processo produttivo per nuovo progetto Opel Grandland BEV, focus su \"Fiancate\".",
        "role_ho": "Assistente Supervisore",
        "desc_ho": "Gestione progetti installazione per Jeep Ineos Grenadier, rimorchi Krone e sistemi convogliatori Opel Grandland.",
        "role_phoenix": "Direttore Supply Chain",
        "desc_phoenix": "Ottimizzazione supply chain biomassa, riduzione costi spedizione e gestione normative trasporto internazionale (Aereo, Mare, Ferro, Gomma).",
        "role_brixia": "Plant Production & Logistics Manager",
        "desc_brixia": "Pressofusione alluminio per Bosch, Continental, Magna. Riorganizzazione supply chain, riduzione fornitori e gestione produttività impianto.",
        "role_scand": "Logistics & Purchasing Manager",
        "desc_scand": "Produzione packaging. Riduzione prezzi acquisto materie prime ed energia. Definizione obiettivi strategici fornitura e gestione contabilità magazzino.",
        "role_serio": "Operation Manager",
        "desc_serio": "Guida fase start-up: conformità costruzione, design layout, reclutamento staff, acquisto macchinari e implementazione ISO 9001.",
        "sec_skills_title": "Competenze Chiave",
        "filter_all": "Tutti",
        "filter_mgmt": "Gestione",
        "filter_tech": "Tecnico",
        "filter_ind": "Industria",
        "sk_supply": "Supply Chain Management",
        "sk_plant": "Plant Operations",
        "sk_lean": "Lean Manufacturing (Kaizen, 5S)",
        "sk_interim": "Interim Management",
        "sk_auto": "Industria Automotive",
        "sk_log": "Ottimizzazione Logistica",
        "sk_crisis": "Gestione Crisi",
        "sk_sqdcpe": "Metriche SQDCPE",
        "sk_iso": "ISO 9001 / IATF",
        "sk_sap": "SAP / AS400 / MS Office",
        "sk_cost": "Riduzione Costi",
        "sk_start": "Leadership Start-up",
        "sec_map_title": "Esperienza Internazionale",
        "sec_map_desc": "Una storia di successi nei principali poli manifatturieri europei.",
        "sec_contact_title": "Contatti"
    },
    "de": {
        "nav_about": "Über mich",
        "nav_experience": "Erfahrung",
        "nav_skills": "Kompetenzen",
        "nav_contact": "Kontakt",
        "hero_title": "Filippo Mario Codecà",
        "hero_subtitle_words": ["Senior Operations Manager", "Supply Chain Experte", "Krisenmanagement Spezialist", "Lean Six Sigma Leiter"],
        "hero_desc": "Steigerung der Effizienz in Automobilindustrie, Werksleitung und Logistikoptimierung in ganz Europa.",
        "btn_contact": "Kontaktieren",
        "btn_profile": "Hogan Profil ansehen",
        "sec_about_title": "Berufsprofil",
        "sec_about_h3": "Führungskraft in der Fertigung",
        "sec_about_p1": "Geboren in Mailand und derzeit in der Slowakei ansässig, bin ich ein erfahrener Manager mit umfassender Erfahrung in der Automobil- und Fertigungsindustrie. Ich spezialisiere mich auf <strong>Werksleitung, Logistik und Supply Chain Optimierung</strong>.",
        "sec_about_p2": "Meine Karriere ist geprägt von Flexibilität und hohem technischen Fokus; ich habe erfolgreich Start-ups, Restrukturierungsprojekte und Interim-Management-Rollen in Europa (Italien, Slowakei, Deutschland) geleitet.",
        "card_lang": "Sprachen",
        "card_edu": "Bildung",
        "sec_exp_title": "Karriereweg",
        "role_nig": "Koordinator / Bauleiter",
        "desc_nig": "Überwachung der Montage von Produktionslinien im Automobilsektor. Tägliche Teamkoordination, Kundenbeziehungen und Materialverfügbarkeit.",
        "role_jlr": "Senior Production Leader (T&F)",
        "desc_jlr": "Leitung Bereich Trim & Final (120 Mitarbeiter). Förderung SQDCPE-Kennzahlen, Sicherheitskonformität und Lean Manufacturing (Kaizen, 5S).",
        "role_opel": "Manager Entwicklung",
        "desc_opel": "Studie zur Fahrgestellgeometrie und Produktionsprozessqualität für neues Opel Grandland BEV Projekt, Fokus \"Karosserieseiten\".",
        "role_ho": "Assistent Supervisor",
        "desc_ho": "Leitung von Installationsprojekten für Jeep Ineos Grenadier, Krone Anhänger und Opel Grandland Fördersysteme.",
        "role_phoenix": "Supply Chain Director",
        "desc_phoenix": "Optimierung der Biomasse-Lieferkette, Reduzierung der Versandkosten und Management internationaler Transportvorschriften.",
        "role_brixia": "Werksleiter Produktion & Logistik",
        "desc_brixia": "Aluminiumdruckguss für Bosch, Continental, Magna. Reorganisation der Lieferkette und Management der Werksproduktivität.",
        "role_scand": "Logistik- & Einkaufsleiter",
        "desc_scand": "Verpackungsherstellung. Reduzierung der Einkaufspreise für Rohstoffe und Energie. Strategische Beschaffungsziele.",
        "role_serio": "Operation Manager",
        "desc_serio": "Leitung der Start-up-Phase: Baukonformität, Layout-Design, Personalrekrutierung, Maschineneinkauf und ISO 9001.",
        "sec_skills_title": "Kernkompetenzen",
        "filter_all": "Alle",
        "filter_mgmt": "Management",
        "filter_tech": "Technisch",
        "filter_ind": "Industrie",
        "sk_supply": "Supply Chain Management",
        "sk_plant": "Werksbetrieb",
        "sk_lean": "Lean Manufacturing (Kaizen, 5S)",
        "sk_interim": "Interim Management",
        "sk_auto": "Automobilindustrie",
        "sk_log": "Logistikoptimierung",
        "sk_crisis": "Krisenmanagement",
        "sk_sqdcpe": "SQDCPE Kennzahlen",
        "sk_iso": "ISO 9001 / IATF",
        "sk_sap": "SAP / AS400 / MS Office",
        "sk_cost": "Kostenreduzierung",
        "sk_start": "Start-up Führung",
        "sec_map_title": "Internationale Erfahrung",
        "sec_map_desc": "Eine Erfolgsbilanz in den wichtigsten europäischen Fertigungszentren.",
        "sec_contact_title": "Kontakt"
    },
    "sk": {
        "nav_about": "O mne",
        "nav_experience": "Skúsenosti",
        "nav_skills": "Zručnosti",
        "nav_contact": "Kontakt",
        "hero_title": "Filippo Mario Codecà",
        "hero_subtitle_words": ["Senior Operations Manager", "Expert na dodávateľský reťazec", "Špecialista krízového manažmentu", "Líder Lean Six Sigma"],
        "hero_desc": "Zvyšovanie efektivity v automobilovom priemysle, riadení závodu a optimalizácii logistiky v celej Európe.",
        "btn_contact": "Kontaktujte ma",
        "btn_profile": "Zobraziť profil Hogan",
        "sec_about_title": "Profesijný Profil",
        "sec_about_h3": "Vedúci pracovník vo výrobe",
        "sec_about_p1": "Narodený v Miláne, momentálne pôsobiaci na Slovensku. Som skúsený manažér s rozsiahlymi skúsenosťami v automobilovom a výrobnom sektore. Špecializujem sa na <strong>riadenie závodu, logistiku a optimalizáciu dodávateľského reťazca</strong>.",
        "sec_about_p2": "Moja kariéra je definovaná flexibilitou a vysokým technickým zameraním, úspešne som riadil start-upy, reštrukturalizačné projekty a úlohy interim manažmentu v Európe (Taliansko, Slovensko, Nemecko).",
        "card_lang": "Jazyky",
        "card_edu": "Vzdelanie",
        "sec_exp_title": "Kariérna Cesta",
        "role_nig": "Koordinátor / Site Manager",
        "desc_nig": "Dohľad nad inštaláciou výrobných liniek v automotive sektore. Denná koordinácia tímu, vzťahy s klientmi a dostupnosť materiálu.",
        "role_jlr": "Senior Production Leader (T&F)",
        "desc_jlr": "Riadenie zóny Trim & Final (120 ľudí). Riadenie metrík SQDCPE, súlad s bezpečnosťou a princípy Lean výroby (Kaizen, 5S).",
        "role_opel": "Manager Development",
        "desc_opel": "Štúdia geometrie podvozku a kvality výrobného procesu pre nový projekt Opel Grandland BEV, zameranie na \"Body Sides\".",
        "role_ho": "Asistent Supervízora",
        "desc_ho": "Riadenie inštalačných projektov pre Jeep Ineos Grenadier, prívesy Krone a dopravníkové systémy Opel Grandland.",
        "role_phoenix": "Riaditeľ Supply Chain",
        "desc_phoenix": "Optimalizácia dodávateľského reťazca biomasy, zníženie prepravných nákladov a riadenie medzinárodných prepravných predpisov.",
        "role_brixia": "Manažér Výroby a Logistiky Závodu",
        "desc_brixia": "Hliníkové tlakové liatie pre Bosch, Continental, Magna. Reorganizácia dodávateľského reťazca, zníženie počtu dodávateľov.",
        "role_scand": "Manažér Logistiky a Nákupu",
        "desc_scand": "Výroba obalov. Zníženie nákupných cien surovín a energie. Definovanie strategických cieľov dodávok.",
        "role_serio": "Operation Manager",
        "desc_serio": "Vedenie fázy start-up: stavebná zhoda, návrh dispozície, nábor zamestnancov, nákup strojov a implementazione ISO 9001.",
        "sec_skills_title": "Kľúčové Kompetencie",
        "filter_all": "Všetky",
        "filter_mgmt": "Manažment",
        "filter_tech": "Technické",
        "filter_ind": "Priemysel",
        "sk_supply": "Riadenie dodávateľského reťazca",
        "sk_plant": "Prevádzka závodu",
        "sk_lean": "Lean výroba (Kaizen, 5S)",
        "sk_interim": "Interim Management",
        "sk_auto": "Automobilový priemysel",
        "sk_log": "Optimalizácia logistiky",
        "sk_crisis": "Krízový manažment",
        "sk_sqdcpe": "Metriky SQDCPE",
        "sk_iso": "ISO 9001 / IATF",
        "sk_sap": "SAP / AS400 / MS Office",
        "sk_cost": "Znižovanie nákladov",
        "sk_start": "Vedenie Start-upu",
        "sec_map_title": "Medzinárodné Skúsenosti",
        "sec_map_desc": "História úspechov v kľúčových európskych výrobných centrách.",
        "sec_contact_title": "Kontakt"
    }
};

// --- Language Switcher Logic ---
function switchLanguage(lang) {
    // 1. Update Buttons State
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.lang === lang) btn.classList.add('active');
    });

    // 2. Update Content
    const elements = document.querySelectorAll('[data-i18n]');
    elements.forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (translations[lang] && translations[lang][key]) {
            if (el.tagName === 'P' || el.tagName === 'DIV' || el.tagName === 'SPAN') {
                el.innerHTML = translations[lang][key];
            } else {
                el.innerText = translations[lang][key];
            }
        }
    });

    // 3. Update Typewriter Data
    const txtElement = document.querySelector('.txt-type');
    if (txtElement && translations[lang]['hero_subtitle_words']) {
        txtElement.setAttribute('data-words', JSON.stringify(translations[lang]['hero_subtitle_words']));
    }

    // 4. Save Preference
    localStorage.setItem('language', lang);
}

// Init Language on Load
const savedLang = localStorage.getItem('language') || 'en';

document.addEventListener('DOMContentLoaded', () => {
    switchLanguage(savedLang);

    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            switchLanguage(btn.dataset.lang);
        });
    });
});

// --- Translations Dictionary ---
const translations = {
    // ... [Content Preserved] ...
    // Note: I will use read_file to properly structure this, but for now I'll just remove the theme toggle block and update colors.
};
// ...


// --- Mobile Menu ---
hamburger.addEventListener('click', () => {
    navLinks.classList.toggle('active');
});

document.querySelectorAll('.nav-links a').forEach(link => {
    link.addEventListener('click', () => {
        navLinks.classList.remove('active');
    });
});

// --- Scroll Progress Bar ---
window.addEventListener('scroll', () => {
    const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
    const scrollHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
    const scrollPercentage = (scrollTop / scrollHeight) * 100;
    progressBar.style.width = scrollPercentage + '%';
});

// --- Dark/Light Mode Toggle ---
// Check Local Storage
const currentTheme = localStorage.getItem('theme');
if (currentTheme === 'light') {
    document.body.classList.remove('dark-mode');
    document.body.classList.add('light-mode');
    themeIcon.classList.remove('fa-sun');
    themeIcon.classList.add('fa-moon');
}

themeToggle.addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
    document.body.classList.toggle('light-mode');

    // Icon Switch (Sun = Light Mode available, Moon = Dark Mode available)
    if (document.body.classList.contains('light-mode')) {
        themeIcon.classList.remove('fa-sun');
        themeIcon.classList.add('fa-moon');
        localStorage.setItem('theme', 'light');
    } else {
        themeIcon.classList.remove('fa-moon');
        themeIcon.classList.add('fa-sun');
        localStorage.setItem('theme', 'dark');
    }
});

// --- Skill Filtering ---
filterBtns.forEach(btn => {
    btn.addEventListener('click', () => {
        // Active Class
        filterBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        const filter = btn.getAttribute('data-filter');

        skillTags.forEach(tag => {
            if (filter === 'all' || tag.getAttribute('data-category') === filter) {
                tag.classList.remove('hidden');
            } else {
                tag.classList.add('hidden');
            }
        });
    });
});

// --- Intersection Observer (Scroll Animations) ---
const observerOptions = {
    threshold: 0.1,
    rootMargin: "0px 0px -50px 0px"
};

const observer = new IntersectionObserver((entries, observer) => {
    entries.forEach(entry => {
        if (!entry.isIntersecting) return;
        entry.target.classList.add('is-visible');
        observer.unobserve(entry.target);
    });
}, observerOptions);

sections.forEach(section => {
    observer.observe(section);
});

// --- Typewriter Effect ---
class TypeWriter {
    constructor(txtElement, words, wait = 3000) {
        this.txtElement = txtElement;
        this.words = words;
        this.txt = '';
        this.wordIndex = 0;
        this.wait = parseInt(wait, 10);
        this.type();
        this.isDeleting = false;
    }

    type() {
        // Current index of word
        const current = this.wordIndex % this.words.length;
        // Get full text of current word
        const fullTxt = this.words[current];

        // Check if deleting
        if (this.isDeleting) {
            // Remove char
            this.txt = fullTxt.substring(0, this.txt.length - 1);
        } else {
            // Add char
            this.txt = fullTxt.substring(0, this.txt.length + 1);
        }

        // Insert txt into element
        this.txtElement.innerHTML = `<span class="txt">${this.txt}</span>`;

        // Initial Type Speed
        let typeSpeed = 100;

        if (this.isDeleting) {
            typeSpeed /= 2;
        }

        // If word is complete
        if (!this.isDeleting && this.txt === fullTxt) {
            // Make pause at end
            typeSpeed = this.wait;
            // Set delete to true
            this.isDeleting = true;
        } else if (this.isDeleting && this.txt === '') {
            this.isDeleting = false;
            // Move to next word
            this.wordIndex++;
            // Pause before start typing
            typeSpeed = 500;
        }

        setTimeout(() => this.type(), typeSpeed);
    }
}

// Init TypeWriter
document.addEventListener('DOMContentLoaded', initTypewriter);

function initTypewriter() {
    const txtElement = document.querySelector('.txt-type');
    const words = JSON.parse(txtElement.getAttribute('data-words'));
    const wait = txtElement.getAttribute('data-wait');
    // Init TypeWriter
    new TypeWriter(txtElement, words, wait);
}


// --- Canvas Interaction (Network Effect) ---
const canvas = document.getElementById('canvas1');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let particlesArray;

// Get Mouse Position
let mouse = {
    x: null,
    y: null,
    radius: (canvas.height / 80) * (canvas.width / 80)
}

window.addEventListener('mousemove',
    function (event) {
        mouse.x = event.x;
        mouse.y = event.y;
    }
);

// Create Particle
class Particle {
    constructor(x, y, directionX, directionY, size, color) {
        this.x = x;
        this.y = y;
        this.directionX = directionX;
        this.directionY = directionY;
        this.size = size;
        this.color = color;
    }
    // Method to draw individual particle
    draw() {
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2, false);
        ctx.fillStyle = '#d4a017'; // Gold particles
        ctx.fill();
    }
    // Check particle position, check mouse position, move the particle, draw the particle
    update() {
        // Check if particle is still within canvas
        if (this.x > canvas.width || this.x < 0) {
            this.directionX = -this.directionX;
        }
        if (this.y > canvas.height || this.y < 0) {
            this.directionY = -this.directionY;
        }

        // Check collision detection - mouse position / particle position
        let dx = mouse.x - this.x;
        let dy = mouse.y - this.y;
        let distance = Math.sqrt(dx * dx + dy * dy);
        if (distance < mouse.radius + this.size) {
            if (mouse.x < this.x && this.x < canvas.width - this.size * 10) {
                this.x += 10;
            }
            if (mouse.x > this.x && this.x > this.size * 10) {
                this.x -= 10;
            }
            if (mouse.y < this.y && this.y < canvas.height - this.size * 10) {
                this.y += 10;
            }
            if (mouse.y > this.y && this.y > this.size * 10) {
                this.y -= 10;
            }
        }
        // Move particle
        this.x += this.directionX;
        this.y += this.directionY;
        // Draw particle
        this.draw();
    }
}

// Create Particle Array
function init() {
    particlesArray = [];
    let numberOfParticles = (canvas.height * canvas.width) / 9000;
    for (let i = 0; i < numberOfParticles; i++) {
        let size = (Math.random() * 2) + 1;
        let x = (Math.random() * ((innerWidth - size * 2) - (size * 2)) + size * 2);
        let y = (Math.random() * ((innerHeight - size * 2) - (size * 2)) + size * 2);
        let directionX = (Math.random() * 0.4) - 0.2; // Slow speed
        let directionY = (Math.random() * 0.4) - 0.2;
        // --- Translations Dictionary ---
        const translations = {
            // ... (translations content kept same, implied) ... 
            // To save context window, I am confident to just update the parts below translations. 
            // Actually, I should use replace_file_content carefully.
            // Let's replace the Logic part downwards.
        };
        // ... I will skip replacing the dictionary since it is large.
        // I'll target the Theme Toggle section and the Particle Colors.


        particlesArray.push(new Particle(x, y, directionX, directionY, size, color));
    }
}

// Connect Particles
function connect() {
    let opacityValue = 1;
    for (let a = 0; a < particlesArray.length; a++) {
        for (let b = a; b < particlesArray.length; b++) {
            let distance = ((particlesArray[a].x - particlesArray[b].x) * (particlesArray[a].x - particlesArray[b].x)) + ((particlesArray[a].y - particlesArray[b].y) * (particlesArray[a].y - particlesArray[b].y));
            if (distance < (canvas.width / 7) * (canvas.height / 7)) {
                opacityValue = 1 - (distance / 20000);
                ctx.strokeStyle = 'rgba(212, 160, 23,' + opacityValue + ')'; // Gold connecting lines
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(particlesArray[a].x, particlesArray[a].y);
                ctx.lineTo(particlesArray[b].x, particlesArray[b].y);
                ctx.stroke();
            }
        }
    }
}

// Animation Loop
function animate() {
    requestAnimationFrame(animate);
    ctx.clearRect(0, 0, innerWidth, innerHeight);

    // Fade out effect for trails (optional, disabling for clean lines)
    // ctx.fillStyle = 'rgba(10,31,51,0.1)';
    // ctx.fillRect(0,0,innerWidth, innerHeight);

    for (let i = 0; i < particlesArray.length; i++) {
        particlesArray[i].update();
    }
    connect();
}

// Resize Event
window.addEventListener('resize',
    function () {
        canvas.width = innerWidth;
        canvas.height = innerHeight;
        mouse.radius = ((canvas.height / 80) * (canvas.height / 80));
        init();
    }
);

// Mouse out event
window.addEventListener('mouseout',
    function () {
        mouse.x = undefined;
        mouse.y = undefined;
    }
);

init();
animate();

// --- Leaflet Map ---
// Check if map container exists
if (document.getElementById('map')) {
    // Initialize Map centered on Europe
    const map = L.map('map').setView([48.5, 12.5], 5); // Center roughly between Italy, Germany, Slovakia

    // Dark Mode compatible tiles (using CartoDB Voyager or Dark Matter based on theme is ideal, but for simplicity using standard OSM or CartoDB)
    // Using CartoDB Voyager for a clean, professional look that fits both themes reasonably well
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 19
    }).addTo(map);

    // Locations Data
    const locations = [
        { name: "Milan, Italy", coords: [45.4642, 9.1900], role: "Education & Origins" },
        { name: "Berlin, Germany", coords: [52.5200, 13.4050], role: "NIG - Site Manager" },
        { name: "Eisenach, Germany", coords: [50.9740, 10.3182], role: "Opel - Manager Development" },
        { name: "Bratislava, Slovakia", coords: [48.1486, 17.1077], role: "H&O Group - Supervisor" },
        { name: "Nitra, Slovakia", coords: [48.3061, 18.0764], role: "Jaguar Land Rover - Senior Leader" },
        { name: "Levice, Slovakia", coords: [48.2156, 18.6071], role: "Home Base / Serioplast" }
    ];

    // Custom Icon (using Navy/Gold colors)
    const customIcon = L.divIcon({
        className: 'custom-map-marker',
        html: '<div style=\"background-color: #d4a017; width: 15px; height: 15px; border-radius: 50%; border: 3px solid #0a1f33; box-shadow: 0 0 5px rgba(0,0,0,0.5);\"></div>',
        iconSize: [20, 20],
        iconAnchor: [10, 10]
    });

    // Add Markers
    locations.forEach(loc => {
        L.marker(loc.coords, { icon: customIcon })
            .addTo(map)
            .bindPopup(`<b>${loc.name}</b><br>${loc.role}`);
    });
}
